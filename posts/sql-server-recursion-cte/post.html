<!--:::{
  "post_title": "SQL Server: Recursividade com WITH common_table_expression (CTE)",
  "post_description": "Um exemplo do uso de common table expression (CTE) usando consultas recursivas.",
  "post_created_at": "Wed May 04 2022 13:20:10 GMT-0300 (Brasilia Standard Time)"
}:::-->

<p>
  Nesse artigo gostaria de mostar um bom exemplo do uso de
  <i>common table expression</i> (CTE) usando consultas recursivas.
</p>
<p>
  Dada uma tabela de empregados (<i>employees</i>), vamos mostrar os empregados
  que reportam, diretamente ou indiretamente, para o empregado 101 e seu
  respectivo nível de subordinação.
</p>
<p>Estrutura da tabela <i>employees:</i></p>
<img src="image01.png" alt="Code image 1" style="max-width: 100%" />
<p>Uma amostra dos dados da tabela employees:</p>
<img src="image02.png" alt="Code image 1" style="max-width: 100%" />
<p>
  Utilizamos a CTE a seguir para retornar os empregados que reportam,
  diretamente ou indiretamente, para o empregado 101 e o seu nível de
  subordinação.
</p>
<pre>
  <code class="language-sql">
    WITH reports_to_101 (eid, emp_last, mgr_id, reportLevel) AS
      (
        SELECT employee_id, last_name, manager_id, 0 reportLevel
        FROM employees
        WHERE employee_id = 101
        UNION ALL
        SELECT e.employee_id, e.last_name, e.manager_id, reportLevel+1
        FROM reports_to_101 r, employees e
        WHERE r.eid = e.manager_id
      )
    SELECT eid, emp_last, mgr_id, reportLevel
    FROM reports_to_101
    ORDER BY reportLevel, eid;
    </code>
</pre>
<p>
  Para CTE acima é dado o alias <i>reports_to_101</i> com quatro colunas para
  retornar os seguintes dados do empregado: o id, o último nome, o id do gerente
  e o nível de subordinação. A CTE <i>reports_to_101</i> possui duas definições
  de consultas:
</p>
<ol>
  <li>
    A primeira definição de consulta é a âncora, a qual retorna o id do
    empregado, último nome, id do gerente e o nível de subordinação do empregado
    101 (valor fixo em zero como ele é o nível mais alto da hierarquia); e,
  </li>
  <li>
    A segunda definição de consulta é a consulta recursiva que faz o join com o
    conteúdo de reports_to_101 e da âncora; e o resultado é adicionado em
    reports_to_101. A operação irá terminar quando não mais linhas foram
    encontradas pela consulta recursiva.
  </li>
</ol>
<p>Resultado final da CTE <i>reports_to_101:</i></p>
<img src="image03.png" alt="Code image 1" style="max-width: 100%" />

<p>I know it's only SQL but I like it.</p>
