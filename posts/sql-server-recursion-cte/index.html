<!-- This is an automatically generated file, do not edit it directly -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
      SQL Server: Recursividade com WITH common_table_expression (CTE)
    </title>
    <meta charset="UTF-8" />

    <!-- SEO -->
    <meta name="author" content="Rodrigo Nascentes" />
    <meta
      name="description"
      content="Um exemplo do uso de common table expression (CTE) usando consultas recursivas."
    />
    <meta
      property="og:title"
      content="SQL Server: Recursividade com WITH common_table_expression (CTE)"
    />
    <meta
      property="og:description"
      content="Um exemplo do uso de common table expression (CTE) usando consultas recursivas."
    />
    <meta property="og:site_name" content="Rodrigo Nascentes" />
    <meta
      property="og:url"
      content="https://ronascentes.github.io/posts/sql-server-recursion-cte"
    />
    <meta
      property="og:image"
      content="https://ronascentes.github.io/card.jpg"
    />
    <meta property="og:type" content="Website" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="627" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="Rodrigo Nascentes" />
    <meta name="twitter:creator" content="Rodrigo Nascentes" />
    <meta
      name="twitter:title"
      content="SQL Server: Recursividade com WITH common_table_expression (CTE)"
    />
    <meta
      name="twitter:description"
      content="Um exemplo do uso de common table expression (CTE) usando consultas recursivas."
    />
    <meta
      name="twitter:image:src"
      content="https://ronascentes.github.io/card.jpg"
    />
    <!--  -->

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="Content-Language" content="en" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <link rel="icon" href="../../favicon.png" />
    <link
      href="https://unpkg.com/plume-css@1.0.13/lib/plume-all.css"
      rel="stylesheet"
      rel="preload"
      as="style"
      media="all"
      defer
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/1post@1.0.3/themes/default-dark.css"
    />
    <link
      href="https://unpkg.com/prismjs@1.28.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --pm-paragraph-font-size: 1.1em;
        --pm-paragraph-font-family: var(--pm-font-family-primary);
      }

      .plume .pm-link,
      .plume a {
        font-size: var(--pm-paragraph-font-size);
      }

      .plume li {
        font-family: var(--pm-font-family-secondary);
        font-size: var(--pm-paragraph-font-size);
      }
    </style>
  </head>
  <body class="plume">
    <div class="pm-container">
      <h2>SQL Server: Recursividade com WITH common_table_expression (CTE)</h2>

      <p>
        <a href="../..">← ← ←</a> &nbsp; 5/4/2022, 1:20:10 PM |
        <strong>Posted by:</strong>
        <a
          href="https://ronascentes.github.io"
          target="_blank"
          rel="noreferrer noopener"
          >Rodrigo Nascentes</a
        >
      </p>

      <hr />

      <p>
        Nesse artigo gostaria de mostar um bom exemplo do uso de
        <i>common table expression</i> (CTE) usando consultas recursivas.
      </p>
      <p>
        Dada uma tabela de empregados (<i>employees</i>), vamos mostrar os
        empregados que reportam, diretamente ou indiretamente, para o empregado
        101 e seu respectivo nível de subordinação.
      </p>
      <p>Estrutura da tabela <i>employees:</i></p>
      <img src="image01.png" alt="Code image 1" style="max-width: 100%" />
      <p>Uma amostra dos dados da tabela employees:</p>
      <img src="image02.png" alt="Code image 1" style="max-width: 100%" />
      <p>
        Utilizamos a CTE a seguir para retornar os empregados que reportam,
        diretamente ou indiretamente, para o empregado 101 e o seu nível de
        subordinação.
      </p>
      <pre>
  <code class="language-sql">
    WITH reports_to_101 (eid, emp_last, mgr_id, reportLevel) AS
      (
        SELECT employee_id, last_name, manager_id, 0 reportLevel
        FROM employees
        WHERE employee_id = 101
        UNION ALL
        SELECT e.employee_id, e.last_name, e.manager_id, reportLevel+1
        FROM reports_to_101 r, employees e
        WHERE r.eid = e.manager_id
      )
    SELECT eid, emp_last, mgr_id, reportLevel
    FROM reports_to_101
    ORDER BY reportLevel, eid;
    </code>
</pre>
      <p>
        Para CTE acima é dado o alias <i>reports_to_101</i> com quatro colunas
        para retornar os seguintes dados do empregado: o id, o último nome, o id
        do gerente e o nível de subordinação. A CTE <i>reports_to_101</i> possui
        duas definições de consultas:
      </p>
      <ol>
        <li>
          A primeira definição de consulta é a âncora, a qual retorna o id do
          empregado, último nome, id do gerente e o nível de subordinação do
          empregado 101 (valor fixo em zero como ele é o nível mais alto da
          hierarquia); e,
        </li>
        <li>
          A segunda definição de consulta é a consulta recursiva que faz o join
          com o conteúdo de reports_to_101 e da âncora; e o resultado é
          adicionado em reports_to_101. A operação irá terminar quando não mais
          linhas foram encontradas pela consulta recursiva.
        </li>
      </ol>
      <p>Resultado final da CTE <i>reports_to_101:</i></p>
      <img src="image03.png" alt="Code image 1" style="max-width: 100%" />

      <p>I know it's only SQL but I like it.</p>
    </div>

    <!-- Prism Code Highlighting -->
    <script src="https://unpkg.com/prismjs@1.28.0/components/prism-core.min.js"></script>
    <script src="https://unpkg.com/prismjs@1.28.0/plugins/autoloader/prism-autoloader.min.js"></script>
  </body>
</html>
